#!/bin/tcsh -f

# Init config

set messageError = '\n\
Use:\
	cpw-configureproject [-C , -c mode, -b, -e app1 app2 appn] -d directory \n\
	\n\
	`[-c, --configure] mode`			Prepare the CMake Build System. `mode` is release or debug \n\
	`[-b, --build]`						Execute the build system \n\
	`[-e, --execute] app1 app2 appn`	Execute in order the passed executables \n\
	`[-d, --dir] directory				Set the work directory \n\
	`[-C, --clean]`						Delete generated files \n\
'

if ( $#argv < 3 ) then
	echo $messageError
	exit 1
endif

# Variables
	set configure = 0
	set mode = ""
	set build = 0
	set execute = 0
	set directory = 0
	set gdb = 0
	set workDirectory = ""

# See parameters
	foreach param($argv)
		switch ($param)
			case "-C":
				echo "- Clean option passed"
				rm -rf debug release mode.log
				exit 0
			breaksw
			case "-c":
				echo "- Configure option passed"
				@ configure = 1
			breaksw
			case "-b":
				echo "- Build option passed"
				@ build = 1
			breaksw
			case "-e":
				echo "- Execute option passed"
				set mode = `cat mode.log`
				if ($mode != "release" && $mode != "debug")
					echo $messageError 1
					exit 1
				else
					touch "$workDirectory/exes.log"
					@ execute = 1
				endif
			breaksw
			case "-d":
				@ directory = 1
			breaksw
			case "-gdb":
				@ gdb = 1
			breaksw
			default:
				if($directory) then
					@ directory = 0
					set workDirectory = $param
					echo "- Work directory: " $workDirectory
				else if ($configure) then
					set mode = $param
					break
				else if ($execute) then
					echo "$param " >> "$workDirectory/exes.log"
				else
					echo $messageError 2
					exit 1
				endif
			breaksw
		endsw
	end
	
# Directory
	if($workDirectory ==  "") then
		echo "No directory especified."
		echo $messageError
		exit 1
	endif
	
# Configure
	if ($configure) then
		# Save mode
		echo $mode > "$workDirectory/mode.log"
		
		# Configure mode
		switch ($mode)
			case "debug":
				echo "- Configure: Debug mode"
				
				# CMake configure
				cmake -S $workDirectory -B "$workDirectory/debug" \
					-DCMAKE_BUILD_TYPE=Debug \
					-DCMAKE_CXX_FLAGS="-Wall -Wextra -g -O0"
					
				# Exit
				exit 0
			breaksw
			case "release":
				echo "- Configure: Release mode"
				
				# CMake configure
				cmake -S $workDirectory -B "$workDirectory/release" \
					-DCMAKE_BUILD_TYPE=Release \
					-DCMAKE_CXX_FLAGS="-O3"
				
				# Exit
				exit 0
			breaksw
			default:
				echo $messageError 4
				exit 1
			breaksw
		endsw
	endif
	
# Build system
	if ($build) then
		# See the build mode
		set mode = `cat mode.log`
		
		# Build per mode
		switch ($mode)
			case "debug":
				echo "- Build: Debug mode. "
				cmake --build "$workDirectory/debug"
			breaksw
			case "release":
				echo "- Build: Release mode. "
				cmake --build "$workDirectory/release"
			breaksw
			default:
				echo $messageError 5
				exit 1
			breaksw
		endsw
	endif

# Execute
	if ($execute == 1) then
		set exes = `cat $workDirectory/exes.log`
		foreach $param($exes)
			echo "- Executing $param"
		end
	endif
